// Prisma schema for ProteinLens meal analysis
// Constitution compliance: traceability, auditability, user data rights

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x", "debian-openssl-1.1.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================
// Enums for Billing (Feature 002)
// ===========================================

enum Plan {
  FREE
  PRO
}

enum SubscriptionStatus {
  active
  canceled
  past_due
  trialing
}

enum UsageType {
  MEAL_ANALYSIS
}

// ===========================================
// User Model (Extended for Billing)
// ===========================================

model User {
  id                    String              @id @default(uuid())
  
  // External identity (from auth provider)
  externalId            String              @unique @db.VarChar(255)
  email                 String?             @db.VarChar(320)
  
  // Stripe billing fields (Feature 002)
  stripeCustomerId      String?             @unique @db.VarChar(255)
  stripeSubscriptionId  String?             @db.VarChar(255)
  plan                  Plan                @default(FREE)
  subscriptionStatus    SubscriptionStatus?
  currentPeriodEnd      DateTime?
  
  // Timestamps
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  
  // Relations
  usage                 Usage[]
  subscriptionEvents    SubscriptionEvent[]
  
  @@index([externalId])
  @@index([stripeCustomerId])
  @@index([plan])
}

// ===========================================
// Usage Tracking (Feature 002)
// ===========================================

model Usage {
  id        String    @id @default(uuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type      UsageType
  mealId    String?   @db.VarChar(255)  // Reference to MealAnalysis.id
  
  createdAt DateTime  @default(now())
  
  @@index([userId, createdAt])
  @@index([userId, type, createdAt])
}

// ===========================================
// Subscription Event Audit Log (Feature 002)
// ===========================================

model SubscriptionEvent {
  id            String    @id @default(uuid())
  userId        String?
  user          User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  eventType     String    @db.VarChar(100)
  stripeEventId String    @unique @db.VarChar(255)
  eventData     Json
  
  processedAt   DateTime?
  createdAt     DateTime  @default(now())
  
  @@index([userId])
  @@index([eventType])
  @@index([stripeEventId])
}

// ===========================================
// Meal Analysis (Core Feature)
// ===========================================

model MealAnalysis {
  id              String   @id @default(uuid())
  userId          String   @db.VarChar(255)
  
  // Blob storage reference (Constitution Principle III: Blob-First Ingestion)
  blobName        String   @db.VarChar(500)
  blobUrl         String   @db.Text  // WITHOUT SAS token (permanent path)
  blobHash        String?  @db.VarChar(64)  // SHA-256 for caching (Principle VI)
  
  // Traceability (Constitution Principle IV)
  requestId       String   @db.Uuid
  
  // AI model metadata
  aiModel         String   @db.VarChar(100)  // e.g., "gpt-5.1-vision"
  aiResponseRaw   Json     // Original AI response (Principle V: schema-valid JSON)
  
  // Analysis results
  totalProtein    Decimal  @db.Decimal(6, 2)
  confidence      String   @db.VarChar(20)  // "high", "medium", "low"
  notes           String?  @db.Text
  
  // User corrections (Constitution Principle IV: maintain original + corrections)
  userCorrections Json?    // Stores user-edited values separately
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  foods           Food[]
  
  // Indexes for performance
  @@index([userId, createdAt])
  @@index([blobHash])
  @@index([requestId])
}

model Food {
  id              String        @id @default(uuid())
  mealAnalysisId  String
  mealAnalysis    MealAnalysis  @relation(fields: [mealAnalysisId], references: [id], onDelete: Cascade)
  
  // Food details from AI
  name            String        @db.VarChar(200)
  portion         String        @db.VarChar(100)
  protein         Decimal       @db.Decimal(6, 2)
  
  // Order for display
  displayOrder    Int           @default(0)
  
  createdAt       DateTime      @default(now())
  
  @@index([mealAnalysisId])
}
