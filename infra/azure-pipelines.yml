# T082: Azure Pipelines CI/CD Configuration
# ProteinLens - Build, Test, and Deploy Pipeline
# GitHub repo + YAML in infra/azure-pipelines.yml
# Security: Gitleaks secret scan + npm audit

name: $(Date:yyyyMMdd).$(Rev:r)

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - backend/**
      - frontend/**
      - infra/**

pr:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - backend/**
      - frontend/**
      - infra/**

variables:
  nodeVersion: '20.x'

  # Azure
  azureSubscription: 'ProteinLens-Azure-Connection'
  functionAppName: 'func-proteinlens'

  # (Optional) if you need them later
  resourceGroupName: 'rg-proteinlens'
  storageAccountName: 'stproteinlens'
  
  # JWT Configuration (defaults - can be overridden in pipeline variables)
  JWT_ISSUER: 'proteinlens-api'
  JWT_AUDIENCE: 'proteinlens-frontend'

stages:
  # ================================
  # Stage 1: Security
  # ================================
  - stage: Security
    displayName: 'Security'
    jobs:
      - job: SecretScan
        displayName: 'Secret scan (Gitleaks)'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            fetchDepth: 0

          - script: |
              set -euo pipefail

              GITLEAKS_VERSION="8.21.2"
              curl -sSL -o gitleaks.tar.gz \
                "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz"
              tar -xzf gitleaks.tar.gz gitleaks
              sudo mv gitleaks /usr/local/bin/gitleaks

              mkdir -p "$(Build.ArtifactStagingDirectory)/security"
              gitleaks detect \
                --source . \
                --report-format sarif \
                --report-path "$(Build.ArtifactStagingDirectory)/security/gitleaks.sarif" \
                --redact \
                --exit-code 1
            displayName: 'Run Gitleaks (fail on secrets)'

          - publish: $(Build.ArtifactStagingDirectory)/security
            artifact: SecurityReports
            displayName: 'Publish security reports'

      - job: DependencyCheck
        displayName: 'Dependency vulnerability scan (npm audit)'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: NodeTool@0
            displayName: 'Use Node.js $(nodeVersion)'
            inputs:
              versionSpec: '$(nodeVersion)'

          - script: |
              set -e
              npm ci
              npm audit --audit-level=high
            displayName: 'Backend: npm audit (non-blocking)'
            workingDirectory: '$(System.DefaultWorkingDirectory)/backend'
            continueOnError: true

          - script: |
              set -e
              npm ci
              npm audit --audit-level=high
            displayName: 'Frontend: npm audit (non-blocking)'
            workingDirectory: '$(System.DefaultWorkingDirectory)/frontend'
            continueOnError: true

  # ================================
  # Stage 2: Build & Test
  # ================================
  - stage: Build
    displayName: 'Build & Test'
    dependsOn: Security
    condition: succeeded()
    jobs:
      - job: Backend
        displayName: 'Backend - build, lint, test'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: NodeTool@0
            displayName: 'Use Node.js $(nodeVersion)'
            inputs:
              versionSpec: '$(nodeVersion)'

          - script: npm ci
            displayName: 'Install backend dependencies'
            workingDirectory: '$(System.DefaultWorkingDirectory)/backend'

          - script: npm run build
            displayName: 'Build backend'
            workingDirectory: '$(System.DefaultWorkingDirectory)/backend'

          - script: npm run lint
            displayName: 'Lint backend (non-blocking)'
            workingDirectory: '$(System.DefaultWorkingDirectory)/backend'
            continueOnError: true

          - script: npm test -- --ci --coverage
            displayName: 'Test backend'
            workingDirectory: '$(System.DefaultWorkingDirectory)/backend'
            env:
              DATABASE_URL: $(DATABASE_URL_TEST)

          - task: PublishTestResults@2
            displayName: 'Publish backend test results'
            condition: succeededOrFailed()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/junit.xml'
              searchFolder: '$(System.DefaultWorkingDirectory)/backend'
              failTaskOnFailedTests: false

          - task: PublishCodeCoverageResults@1
            displayName: 'Publish backend code coverage'
            condition: succeededOrFailed()
            inputs:
              codeCoverageTool: 'Cobertura'
              summaryFileLocation: '$(System.DefaultWorkingDirectory)/backend/coverage/cobertura-coverage.xml'
              failIfCoverageEmpty: false

          # Package backend for Azure Functions
          - task: ArchiveFiles@2
            displayName: 'Archive backend artifact'
            inputs:
              rootFolderOrFile: '$(System.DefaultWorkingDirectory)/backend'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/backend.zip'
              replaceExistingArchive: true

          - publish: $(Build.ArtifactStagingDirectory)/backend.zip
            artifact: BackendArtifact
            displayName: 'Publish backend artifact'

      - job: Frontend
        displayName: 'Frontend - build'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: NodeTool@0
            displayName: 'Use Node.js $(nodeVersion)'
            inputs:
              versionSpec: '$(nodeVersion)'

          - script: npm ci
            displayName: 'Install frontend dependencies'
            workingDirectory: '$(System.DefaultWorkingDirectory)/frontend'

          - script: npm run build
            displayName: 'Build frontend'
            workingDirectory: '$(System.DefaultWorkingDirectory)/frontend'
            env:
              VITE_API_URL: '/api'

          - script: npm run lint
            displayName: 'Lint frontend (non-blocking)'
            workingDirectory: '$(System.DefaultWorkingDirectory)/frontend'
            continueOnError: true

          - task: ArchiveFiles@2
            displayName: 'Archive frontend artifact'
            inputs:
              rootFolderOrFile: '$(System.DefaultWorkingDirectory)/frontend/dist'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/frontend.zip'
              replaceExistingArchive: true

          - publish: $(Build.ArtifactStagingDirectory)/frontend.zip
            artifact: FrontendArtifact
            displayName: 'Publish frontend artifact'

      # Feature 012: Admin Dashboard build job
      - job: AdminDashboard
        displayName: 'Admin Dashboard - build'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: NodeTool@0
            displayName: 'Use Node.js $(nodeVersion)'
            inputs:
              versionSpec: '$(nodeVersion)'

          - script: npm ci
            displayName: 'Install admin dependencies'
            workingDirectory: '$(System.DefaultWorkingDirectory)/admin'

          - script: npm run build
            displayName: 'Build admin dashboard'
            workingDirectory: '$(System.DefaultWorkingDirectory)/admin'
            env:
              VITE_API_URL: '/api'

          - script: npm run lint
            displayName: 'Lint admin (non-blocking)'
            workingDirectory: '$(System.DefaultWorkingDirectory)/admin'
            continueOnError: true

          - task: ArchiveFiles@2
            displayName: 'Archive admin artifact'
            inputs:
              rootFolderOrFile: '$(System.DefaultWorkingDirectory)/admin/dist'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/admin.zip'
              replaceExistingArchive: true

          - publish: $(Build.ArtifactStagingDirectory)/admin.zip
            artifact: AdminArtifact
            displayName: 'Publish admin artifact'

  # ================================
  # Stage 3: Deploy Infrastructure (Bicep)
  # ================================
  - stage: DeployInfrastructure
    displayName: 'Deploy Infrastructure'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: DeployMonitoring
        displayName: 'Deploy monitoring and alerts'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self

          - task: AzureCLI@2
            displayName: 'Deploy monitoring.bicep'
            inputs:
              azureSubscription: '$(azureSubscription)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                set -e
                echo "Deploying monitoring resources..."
                az deployment group create \
                  --resource-group $(RESOURCE_GROUP_NAME) \
                  --template-file infra/bicep/monitoring.bicep \
                  --parameters @infra/bicep/parameters/prod.parameters.json \
                  --name "monitoring-$(Build.BuildNumber)"
                echo "Monitoring deployment complete"

  # ================================
  # Stage 4: Pre-Deployment Infrastructure Sync
  # ================================
  - stage: SyncInfrastructure
    displayName: 'Sync Infrastructure'
    dependsOn: 
      - Build
      - DeployInfrastructure
    condition: succeeded()
    jobs:
      - job: SyncCredentials
        displayName: 'Sync database and JWT credentials'
        pool:
          vmImage: 'windows-latest'
        steps:
          - checkout: self

          - task: AzurePowerShell@5
            displayName: 'Sync PostgreSQL and JWT secrets with Key Vault'
            inputs:
              azureSubscription: '$(azureSubscription)'
              ScriptType: 'FilePath'
              ScriptPath: '$(System.DefaultWorkingDirectory)/scripts/sync-db-credentials.ps1'
              ScriptArguments: |
                -SubscriptionId "$(AZURE_SUBSCRIPTION_ID)" \
                -ResourceGroupName "$(RESOURCE_GROUP_NAME)" \
                -PostgresServerName "$(POSTGRES_SERVER_NAME)" \
                -KeyVaultName "$(KEY_VAULT_NAME)" \
                -DatabasePassword "$(DATABASE_PASSWORD)" \
                -DatabaseAdminUsername "pgadmin" \
                -DatabaseName "proteinlens" \
                -FunctionAppName "$(FUNCTION_APP_NAME)" \
                -JwtIssuer "$(JWT_ISSUER)" \
                -JwtAudience "$(JWT_AUDIENCE)" \
                -Verbose
              azurePowerShellVersion: 'LatestVersion'
              errorActionPreference: 'stop'
            env:
              AZURE_SUBSCRIPTION_ID: $(AZURE_SUBSCRIPTION_ID)
              RESOURCE_GROUP_NAME: $(RESOURCE_GROUP_NAME)
              POSTGRES_SERVER_NAME: $(POSTGRES_SERVER_NAME)
              KEY_VAULT_NAME: $(KEY_VAULT_NAME)
              DATABASE_PASSWORD: $(DATABASE_PASSWORD)
              FUNCTION_APP_NAME: $(FUNCTION_APP_NAME)
              JWT_ISSUER: $(JWT_ISSUER)
              JWT_AUDIENCE: $(JWT_AUDIENCE)

  # ================================
  # Stage 5: Deploy to Staging (develop)
  # ================================
  - stage: DeployStaging
    displayName: 'Deploy - Staging'
    dependsOn: 
      - Build
      - SyncInfrastructure
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/develop'))
    jobs:
      - deployment: BackendStaging
        displayName: 'Deploy backend to staging'
        environment: 'staging'
        pool:
          vmImage: 'ubuntu-latest'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: BackendArtifact

                - task: AzureFunctionApp@2
                  displayName: 'Deploy Azure Functions (staging)'
                  inputs:
                    connectedServiceNameARM: '$(azureSubscription)'
                    appType: 'functionApp'
                    appName: '$(functionAppName)-staging'
                    package: '$(Pipeline.Workspace)/BackendArtifact/backend.zip'
                    deploymentMethod: 'auto'

      - deployment: FrontendStaging
        displayName: 'Deploy frontend to staging'
        environment: 'staging'
        pool:
          vmImage: 'ubuntu-latest'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: FrontendArtifact

                # If you actually use Azure Static Web Apps, this expects the token secret to be set
                - task: AzureStaticWebApp@0
                  displayName: 'Deploy Azure Static Web Apps (staging)'
                  inputs:
                    # For this task, app_location is the folder of your app source.
                    # Since we are deploying a prebuilt artifact zip, we unzip first.
                    skip_app_build: true
                    azure_static_web_apps_api_token: $(AZURE_SWA_TOKEN_STAGING)
                    app_location: '/'

                # NOTE:
                # AzureStaticWebApp@0 doesn't natively accept a zip artifact as-is.
                # If you want "artifact-based" deploy, consider switching to the SWA CLI (see note below).

  # ================================
  # Stage 6: Deploy to Production (main)
  # ================================
  - stage: DeployProduction
    displayName: 'Deploy - Production'
    dependsOn:
      - Build
      - DeployInfrastructure
      - SyncInfrastructure
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: BackendProduction
        displayName: 'Deploy backend to production'
        environment: 'production'
        pool:
          vmImage: 'ubuntu-latest'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: BackendArtifact

                - task: AzureFunctionApp@2
                  displayName: 'Deploy Azure Functions (production)'
                  inputs:
                    connectedServiceNameARM: '$(azureSubscription)'
                    appType: 'functionApp'
                    appName: '$(functionAppName)'
                    package: '$(Pipeline.Workspace)/BackendArtifact/backend.zip'
                    deploymentMethod: 'auto'

      - deployment: FrontendProduction
        displayName: 'Deploy frontend to production'
        environment: 'production'
        pool:
          vmImage: 'ubuntu-latest'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: FrontendArtifact

                - task: AzureStaticWebApp@0
                  displayName: 'Deploy Azure Static Web Apps (production)'
                  inputs:
                    skip_app_build: true
                    azure_static_web_apps_api_token: $(AZURE_SWA_TOKEN_PRODUCTION)
                    app_location: '/'

      # Feature 012: Admin Dashboard deployment
      - deployment: AdminProduction
        displayName: 'Deploy admin dashboard to production'
        environment: 'production'
        pool:
          vmImage: 'ubuntu-latest'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: AdminArtifact

                - task: AzureStaticWebApp@0
                  displayName: 'Deploy Admin Static Web App (production)'
                  inputs:
                    skip_app_build: true
                    azure_static_web_apps_api_token: $(AZURE_ADMIN_SWA_TOKEN_PRODUCTION)
                    app_location: '/'

      - job: SmokeTest
        displayName: 'Production smoke test'
        dependsOn:
          - BackendProduction
          - FrontendProduction
          - AdminProduction
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - script: |
              set -e
              echo "Running smoke tests against production..."
              curl -f https://proteinlens.com/api/health
              curl -f https://proteinlens.com
              curl -f https://admin.proteinlens.com || echo "Admin smoke test skipped (may not be configured yet)"
              echo "Smoke tests passed!"
            displayName: 'Health check'
