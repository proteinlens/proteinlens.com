name: Deploy Frontend Web

on:
  workflow_call:
    inputs:
      resource_group:
        description: 'Azure Resource Group'
        required: true
        type: string
      staticwebapp_name:
        description: 'Static Web App Name'
        required: true
        type: string
      api_url:
        description: 'API base URL for Vite build'
        required: true
        type: string

permissions:
  contents: read
  id-token: write

env:
  NODE_VERSION: '20'

jobs:
  # Combined build and deploy in single job to avoid artifact storage quota issues
  # This eliminates the need for upload/download artifacts between jobs
  build_and_deploy:
    name: Build & Deploy Frontend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Display versions
        run: |
          echo "Node: $(node --version)"
          echo "npm: $(npm --version)"
          echo "Vite API URL: ${{ inputs.api_url }}"

      - name: Install dependencies
        run: |
          cd frontend
          npm ci --verbose
          echo "âœ… Dependencies installed"

      - name: Create production environment file
        run: |
          cd frontend
          # Vite uses .env.production for production builds (npm run build)
          # This takes precedence over .env and shell environment variables
          cat > .env.production << EOF
          VITE_API_URL=${{ inputs.api_url }}
          VITE_HCAPTCHA_SITE_KEY=${{ secrets.VITE_HCAPTCHA_SITE_KEY }}
          EOF
          echo "âœ… Created .env.production with API URL and hCaptcha"
          # Show env vars (masking sensitive values)
          echo "VITE_API_URL=${{ inputs.api_url }}"
          echo "VITE_HCAPTCHA_SITE_KEY=***"

      - name: Build with Vite
        run: |
          cd frontend
          npm run build
          echo "âœ… Frontend build completed"
          # Verify the API URL was baked into the build
          if grep -q "${{ inputs.api_url }}" dist/assets/*.js 2>/dev/null; then
            echo "âœ… API URL successfully baked into build"
          else
            echo "âš ï¸ Warning: API URL may not be in build, checking for /api fallback..."
          fi

      - name: Validate build artifact
        run: |
          if [ ! -f "frontend/dist/index.html" ]; then
            echo "âŒ Missing frontend/dist/index.html"
            exit 1
          fi
          echo "âœ… Build artifact validated"

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Fetch Static Web App token
        id: swa
        run: |
          RG="${{ inputs.resource_group }}"
          SWA_NAME="${{ inputs.staticwebapp_name }}"
          echo "ðŸ” Getting token for SWA: $SWA_NAME in RG: $RG"
          TOKEN=$(az staticwebapp secrets list --name "$SWA_NAME" --resource-group "$RG" --query properties.apiKey -o tsv)
          if [ -z "$TOKEN" ]; then
            echo "âŒ Failed to retrieve SWA token"
            exit 1
          fi
          echo "::add-mask::$TOKEN"
          echo "token=$TOKEN" >> "$GITHUB_OUTPUT"
          echo "âœ… Token retrieved"

      - name: Deploy to Static Web Apps
        uses: azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ steps.swa.outputs.token }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: 'upload'
          app_location: 'frontend/dist'
          skip_app_build: true
