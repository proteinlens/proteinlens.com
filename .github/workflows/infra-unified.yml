name: Deploy Infrastructure (Unified)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: Environment name (prod/staging/dev)
        required: true
        default: prod
      resource_group:
        description: Resource group name
        required: true
        default: proteinlens-prod-v2

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Validate Bicep
        run: |
          az bicep build --file infra/bicep/subscription-main.bicep

      - name: Deploy Subscription Stack
        env:
          ENV: ${{ github.event.inputs.environment }}
          RG: ${{ github.event.inputs.resource_group }}
        run: |
          LOCATION=eastus2
          DEPLOY_NAME="proteinlens-${ENV}-$(date +%s)"

          az deployment sub create \
            --location "$LOCATION" \
            --template-file infra/bicep/subscription-main.bicep \
            --parameters \
              location="$LOCATION" \
              resourceGroupName="$RG" \
              environmentName="$ENV" \
              appNamePrefix="proteinlens" \
              postgresAdminPassword='${{ secrets.DATABASE_ADMIN_PASSWORD }}' \
              openaiApiKey='${{ secrets.OPENAI_API_KEY }}' \
              stripeSecretKey='${{ secrets.STRIPE_SECRET_KEY }}' \
              stripeWebhookSecret='${{ secrets.STRIPE_WEBHOOK_SECRET }}' \
            --name "$DEPLOY_NAME"

      - name: Show Outputs
        env:
          ENV: ${{ github.event.inputs.environment }}
        run: |
          echo "âœ… Infrastructure deployment complete"
          LAST_DEPLOY=$(az deployment sub list --query "[?contains(name, 'proteinlens-${ENV}')]|[-1].name" -o tsv)
          echo "Deployment: $LAST_DEPLOY"
          az deployment sub show --name "$LAST_DEPLOY" --query "properties.outputs" -o json | tee /tmp/outputs.json
          FUNC_URL=$(jq -r '.functionAppUrl.value' /tmp/outputs.json)
          SWA_URL=$(jq -r '.staticWebAppUrl.value' /tmp/outputs.json)
          KV_URI=$(jq -r '.keyVaultUri.value' /tmp/outputs.json)
          SA_NAME=$(jq -r '.storageAccountName.value' /tmp/outputs.json)
          echo "Function App URL: $FUNC_URL"
          echo "Static Web App URL: $SWA_URL"
          echo "Key Vault URI: $KV_URI"
          echo "Storage Account: $SA_NAME"

      - name: Summary
        run: |
          echo "## Infrastructure Deployed" >> $GITHUB_STEP_SUMMARY
          echo "- Environment: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- Resource Group: ${{ github.event.inputs.resource_group }}" >> $GITHUB_STEP_SUMMARY
          echo "- Template: infra/bicep/subscription-main.bicep" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Outputs" >> $GITHUB_STEP_SUMMARY
          echo "- Function App URL: $(jq -r '.functionAppUrl.value' /tmp/outputs.json)" >> $GITHUB_STEP_SUMMARY
          echo "- Static Web App URL: $(jq -r '.staticWebAppUrl.value' /tmp/outputs.json)" >> $GITHUB_STEP_SUMMARY
          echo "- Key Vault URI: $(jq -r '.keyVaultUri.value' /tmp/outputs.json)" >> $GITHUB_STEP_SUMMARY
          echo "- Storage Account: $(jq -r '.storageAccountName.value' /tmp/outputs.json)" >> $GITHUB_STEP_SUMMARY