name: Secret Scanning

# Constitution Principle X: Key Vault Supremacy
# Prevents accidental commit of raw secrets to repository

on:
  push:
    branches: ['**']
  pull_request:
    branches: [main]

permissions:
  contents: read
  security-events: write

jobs:
  secret-scan:
    name: Scan for Secrets
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comprehensive scan
      
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Check for hardcoded API keys
        run: |
          echo "Scanning for common secret patterns..."
          
          # OpenAI API key pattern
          if git grep -E 'sk-[A-Za-z0-9]{32,}' -- '*.ts' '*.js' '*.json' '*.yml' '*.yaml'; then
            echo "❌ FAIL: OpenAI API key pattern detected"
            exit 1
          fi
          
          # Azure Cognitive Services key pattern
          if git grep -E '[0-9a-f]{32}' -- '*.ts' '*.js' | grep -i 'key'; then
            echo "⚠️ WARNING: Potential Azure key pattern detected"
            echo "Review matches above to ensure they are not secrets"
          fi
          
          # Generic API key assignments
          if git grep -E '(apiKey|api_key|API_KEY)\s*=\s*["\x27][A-Za-z0-9+/=]{20,}["\x27]' -- '*.ts' '*.js'; then
            echo "❌ FAIL: Hardcoded API key assignment detected"
            exit 1
          fi
          
          echo "✅ PASS: No obvious secrets detected"
      
      - name: Check for Key Vault reference usage
        run: |
          echo "Verifying Key Vault references in config files..."
          
          # Check GitHub Actions workflows use Key Vault patterns
          if grep -r 'AZURE_OPENAI_API_KEY' .github/workflows/ | grep -v '@Microsoft.KeyVault'; then
            echo "⚠️ WARNING: AZURE_OPENAI_API_KEY used without Key Vault reference"
          fi
          
          # Check Bicep files use Key Vault references
          if grep -r 'OPENAI.*API.*KEY' infra/bicep/ | grep -v 'KeyVault' | grep -v 'keyvault'; then
            echo "⚠️ WARNING: OpenAI key referenced in Bicep without Key Vault"
          fi
          
          echo "✅ Key Vault reference check complete"
      
      - name: Validate script safety
        run: |
          echo "Checking scripts avoid logging secrets..."
          
          # Check scripts use silent modes
          if grep -E 'echo.*\$.*KEY' scripts/foundry-*.sh; then
            echo "❌ FAIL: Script echoes variable that may contain key"
            exit 1
          fi
          
          # Verify --output none usage for sensitive commands
          if ! grep -q 'keyvault secret set.*--output none' scripts/foundry-up.sh; then
            echo "⚠️ WARNING: Key Vault secret set may log output"
          fi
          
          echo "✅ Script safety check complete"
