name: Database Backup

on:
  # Run daily at 2 AM UTC
  schedule:
    - cron: '0 2 * * *'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      retention_days:
        description: 'Backup retention in days'
        required: false
        default: '30'

# Grant OIDC token for Azure login
permissions:
  id-token: write
  contents: read

jobs:
  backup:
    name: Backup PostgreSQL Database
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Azure Login (using OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Fetch DATABASE_URL from Azure Key Vault
        id: get-db-url
        run: |
          echo "üîÑ Fetching DATABASE_URL from Function App..."
          DATABASE_URL_RAW=$(az functionapp config appsettings list \
            --name func-proteinlens \
            --resource-group ${{ vars.AZURE_RESOURCE_GROUP }} \
            --query "[?name=='DATABASE_URL'].value" -o tsv)
          
          if [[ "$DATABASE_URL_RAW" == @Microsoft.KeyVault* ]]; then
            echo "üîê Resolving Key Vault reference..."
            VAULT_NAME=$(echo "$DATABASE_URL_RAW" | sed -n 's/.*VaultName=\([^;)]*\).*/\1/p')
            SECRET_NAME=$(echo "$DATABASE_URL_RAW" | sed -n 's/.*SecretName=\([^;)]*\).*/\1/p')
            
            DATABASE_URL=$(az keyvault secret show \
              --vault-name "$VAULT_NAME" \
              --name "$SECRET_NAME" \
              --query "value" -o tsv)
          else
            DATABASE_URL="$DATABASE_URL_RAW"
          fi
          
          echo "‚úÖ DATABASE_URL retrieved"
          echo "DATABASE_URL=$DATABASE_URL" >> $GITHUB_OUTPUT

      - name: Create database backup
        env:
          DATABASE_URL: ${{ steps.get-db-url.outputs.DATABASE_URL }}
          PGPASSWORD: ${{ steps.get-db-url.outputs.DATABASE_URL }}
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          BACKUP_FILE="proteinlens_backup_${TIMESTAMP}.sql.gz"
          
          echo "üì¶ Creating database backup: $BACKUP_FILE"
          
          # Extract connection details from DATABASE_URL
          DB_HOST=$(echo "$DATABASE_URL" | sed -n 's/.*@\([^:]*\):.*/\1/p')
          DB_PORT=$(echo "$DATABASE_URL" | sed -n 's/.*:\([0-9]*\)\/.*/\1/p')
          DB_NAME=$(echo "$DATABASE_URL" | sed -n 's/.*\/\([^?]*\).*/\1/p')
          DB_USER=$(echo "$DATABASE_URL" | sed -n 's/.*:\/\/\([^:]*\):.*/\1/p')
          DB_PASS=$(echo "$DATABASE_URL" | sed -n 's/.*:\/\/[^:]*:\([^@]*\)@.*/\1/p')
          
          # Create compressed backup
          PGPASSWORD="$DB_PASS" pg_dump \
            -h "$DB_HOST" \
            -p "$DB_PORT" \
            -U "$DB_USER" \
            -d "$DB_NAME" \
            --no-owner \
            --no-acl \
            --clean \
            --if-exists \
            | gzip > "$BACKUP_FILE"
          
          BACKUP_SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
          echo "‚úÖ Backup created: $BACKUP_SIZE"
          echo "BACKUP_FILE=$BACKUP_FILE" >> $GITHUB_ENV

      - name: Upload to Azure Blob Storage
        run: |
          CONTAINER_NAME="database-backups"
          STORAGE_ACCOUNT=$(az storage account list \
            --resource-group ${{ vars.AZURE_RESOURCE_GROUP }} \
            --query "[?starts_with(name, 'stproteinlens')].name" -o tsv | head -1)
          
          # Create storage account if it doesn't exist
          if [ -z "$STORAGE_ACCOUNT" ]; then
            echo "üì¶ Creating new storage account for backups..."
            STORAGE_ACCOUNT="stproteinlensbackup"
            az storage account create \
              --name "$STORAGE_ACCOUNT" \
              --resource-group ${{ vars.AZURE_RESOURCE_GROUP }} \
              --location ${{ vars.AZURE_LOCATION }} \
              --sku Standard_LRS \
              --kind StorageV2 \
              --allow-blob-public-access false \
              --min-tls-version TLS1_2
            echo "‚úÖ Storage account created: $STORAGE_ACCOUNT"
          fi
          
          echo "üì§ Uploading to Azure Storage: $STORAGE_ACCOUNT/$CONTAINER_NAME"
          
          # Create container if it doesn't exist
          az storage container create \
            --name "$CONTAINER_NAME" \
            --account-name "$STORAGE_ACCOUNT" \
            --auth-mode login \
            --only-show-errors || true
          
          # Upload backup
          az storage blob upload \
            --account-name "$STORAGE_ACCOUNT" \
            --container-name "$CONTAINER_NAME" \
            --name "$BACKUP_FILE" \
            --file "$BACKUP_FILE" \
            --auth-mode login \
            --overwrite
          
          echo "‚úÖ Backup uploaded successfully"

      - name: Clean up old backups
        run: |
          CONTAINER_NAME="database-backups"
          RETENTION_DAYS=${{ github.event.inputs.retention_days || '30' }}
          STORAGE_ACCOUNT=$(az storage account list \
            --resource-group ${{ vars.AZURE_RESOURCE_GROUP }} \
            --query "[?starts_with(name, 'stproteinlens')].name" -o tsv | head -1)
          
          # Skip cleanup if storage account doesn't exist (first run)
          if [ -z "$STORAGE_ACCOUNT" ]; then
            echo "‚ö†Ô∏è No storage account found, skipping cleanup"
            exit 0
          fi
          
          echo "üßπ Cleaning backups older than $RETENTION_DAYS days..."
          
          CUTOFF_DATE=$(date -d "$RETENTION_DAYS days ago" +%Y-%m-%d)
          
          az storage blob list \
            --account-name "$STORAGE_ACCOUNT" \
            --container-name "$CONTAINER_NAME" \
            --auth-mode login \
            --query "[?properties.creationTime < '$CUTOFF_DATE'].name" -o tsv | \
          while read -r blob; do
            if [ -n "$blob" ]; then
              echo "  Deleting: $blob"
              az storage blob delete \
                --account-name "$STORAGE_ACCOUNT" \
                --container-name "$CONTAINER_NAME" \
                --name "$blob" \
                --auth-mode login \
                --only-show-errors
            fi
          done
          
          echo "‚úÖ Cleanup completed"

      - name: Backup summary
        if: always()
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üìä Backup Summary"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "File: $BACKUP_FILE"
          echo "Timestamp: $(date)"
          echo "Retention: ${{ github.event.inputs.retention_days || '30' }} days"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
