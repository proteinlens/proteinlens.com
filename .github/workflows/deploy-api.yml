name: Deploy Backend API

on:
  workflow_call:
    inputs:
      resource_group:
        description: 'Azure Resource Group'
        required: true
        type: string
      functionapp_name:
        description: 'Azure Function App Name'
        required: true
        type: string

permissions:
  contents: read
  id-token: write

env:
  NODE_VERSION: '20'

jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'backend/package-lock.json'

      - name: Display versions
        run: |
          echo "Node: $(node --version)"
          echo "npm: $(npm --version)"

      - name: Install dependencies
        run: |
          cd backend
          npm ci --verbose
          echo "âœ… Dependencies installed"

      - name: Generate Prisma Client
        run: |
          cd backend
          npm run prisma:generate
          echo "âœ… Prisma client generated"

      - name: Build TypeScript
        run: |
          cd backend
          npm run build
          echo "âœ… TypeScript build completed"

      - name: Run unit tests
        run: |
          cd backend
          npm run test:unit || echo "âš ï¸ Unit tests skipped or failed"
          echo "âœ… Tests completed"

      - name: Package Function App
        run: |
          cd backend
          # Validate host.json exists
          if [ ! -f "host.json" ]; then
            echo "âŒ host.json missing at backend/"
            exit 1
          fi
          # Ensure dist directory exists
          if [ ! -d "dist" ]; then
            echo "âŒ Build output directory not found"
            exit 1
          fi
          
          # Stage a deployable Functions app
          # Azure Functions v4 with ESM requires:
          # 1. Files at root level (not in dist/)
          # 2. package.json with "type": "module" and correct "main"
          # 3. All production dependencies in node_modules
          rm -rf .deploy && mkdir -p .deploy
          
          # Copy host.json
          cp host.json .deploy/
          
          # Copy Prisma schema and migrations
          cp -r prisma .deploy/prisma
          
          # Copy compiled JS files to ROOT (not in dist subfolder)
          cp -r dist/* .deploy/
          
          # Create production package.json
          # - main points to index.js (now at root)
          # - type: module for ESM
          # - remove devDependencies
          cat package.json | jq 'del(.devDependencies) | .main = "index.js"' > .deploy/package.json
          
          # Install only production dependencies fresh
          echo "ðŸ“¦ Installing production dependencies..."
          cd .deploy
          npm install --production --ignore-scripts
          
          # Generate Prisma client (required - this creates .prisma/client)
          echo "ðŸ“¦ Generating Prisma client..."
          npx prisma generate
          
          # Verify Prisma client was generated
          if [ ! -d "node_modules/.prisma/client" ]; then
            echo "âŒ Prisma client not generated - .prisma/client missing"
            exit 1
          fi
          echo "âœ… Prisma client generated"
          
          # Verify @azure/functions is installed
          if [ ! -d "node_modules/@azure/functions" ]; then
            echo "âŒ @azure/functions not found in node_modules"
            exit 1
          fi
          
          cd ..
          echo "âœ… Deployment folder prepared at backend/.deploy"
          echo "ðŸ“ Structure:"
          find .deploy -maxdepth 2 -type f | head -30
          echo "ðŸ“„ package.json:"
          cat .deploy/package.json | jq '{name, type, main}'
          echo "ðŸ“¦ Key dependencies:"
          ls -la .deploy/node_modules/@azure/ || echo "No @azure packages"

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Verify Function App exists
        run: |
          RG="${{ inputs.resource_group }}"
          FA_NAME="${{ inputs.functionapp_name }}"
          echo "ðŸ” Checking Function App: $FA_NAME in RG: $RG"
          if az functionapp show --name "$FA_NAME" --resource-group "$RG" &> /dev/null; then
            echo "âœ… Function App found"
          else
            echo "âŒ Function App not found"
            exit 1
          fi

      - name: Ensure Storage RBAC Permissions (FIRST)
        run: |
          RG="${{ inputs.resource_group }}"
          FA_NAME="${{ inputs.functionapp_name }}"
          
          # Get Function App managed identity
          FUNC_IDENTITY=$(az functionapp identity show \
            --name "$FA_NAME" \
            --resource-group "$RG" \
            --query "principalId" -o tsv)
          
          if [ -z "$FUNC_IDENTITY" ]; then
            echo "âš ï¸ No managed identity found for Function App"
            exit 0
          fi
          
          # Get storage account from Function App settings
          STORAGE_NAME=$(az functionapp config appsettings list \
            --name "$FA_NAME" \
            --resource-group "$RG" \
            --query "[?name=='AzureWebJobsStorage__accountName'].value" -o tsv)
          
          if [ -z "$STORAGE_NAME" ]; then
            # Try getting from AZURE_STORAGE_ACCOUNT_NAME
            STORAGE_NAME=$(az functionapp config appsettings list \
              --name "$FA_NAME" \
              --resource-group "$RG" \
              --query "[?name=='AZURE_STORAGE_ACCOUNT_NAME'].value" -o tsv)
          fi
          
          if [ -z "$STORAGE_NAME" ]; then
            echo "âš ï¸ Could not determine storage account name"
            exit 0
          fi
          
          echo "ðŸ“¦ Storage Account: $STORAGE_NAME"
          echo "ðŸ” Function App Identity: $FUNC_IDENTITY"
          
          # Get storage account ID
          STORAGE_ID=$(az storage account show \
            --name "$STORAGE_NAME" \
            --resource-group "$RG" \
            --query "id" -o tsv 2>/dev/null || echo "")
          
          if [ -z "$STORAGE_ID" ]; then
            echo "âš ï¸ Storage account not found in resource group"
            exit 0
          fi
          
          echo "ðŸ” Ensuring storage RBAC roles..."
          
          # Storage Blob Data Owner
          az role assignment create \
            --assignee "$FUNC_IDENTITY" \
            --role "Storage Blob Data Owner" \
            --scope "$STORAGE_ID" \
            2>/dev/null || echo "  - Blob Data Owner: already assigned"
          
          # Storage Queue Data Contributor
          az role assignment create \
            --assignee "$FUNC_IDENTITY" \
            --role "Storage Queue Data Contributor" \
            --scope "$STORAGE_ID" \
            2>/dev/null || echo "  - Queue Data Contributor: already assigned"
          
          # Storage Table Data Contributor
          az role assignment create \
            --assignee "$FUNC_IDENTITY" \
            --role "Storage Table Data Contributor" \
            --scope "$STORAGE_ID" \
            2>/dev/null || echo "  - Table Data Contributor: already assigned"
          
          echo "âœ… Storage RBAC permissions verified"
          
          # Wait for RBAC propagation before any other operations
          echo "â³ Waiting 30s for RBAC propagation..."
          sleep 30

      - name: Configure Function App Settings
        run: |
          RG="${{ inputs.resource_group }}"
          FA_NAME="${{ inputs.functionapp_name }}"
          echo "âš™ï¸ Configuring Function App settings for Azure Functions v4 + ESM..."
          
          # Enable Azure Functions v4 Node.js programming model
          az functionapp config appsettings set \
            --name "$FA_NAME" \
            --resource-group "$RG" \
            --settings \
              "AzureWebJobsFeatureFlags=EnableWorkerIndexing" \
              "SCM_DO_BUILD_DURING_DEPLOYMENT=false" \
            --output none
          
          echo "âœ… Function App settings configured"
          
          # CRITICAL: Wait for SCM to stabilize after settings change
          echo "â³ Waiting 60s for SCM container to stabilize..."
          sleep 60

      - name: Create deployment zip
        run: |
          cd backend/.deploy
          zip -r ../deploy.zip .
          ls -la ../deploy.zip
          echo "âœ… Created deploy.zip"

      - name: Deploy to Azure Functions
        run: |
          RG="${{ inputs.resource_group }}"
          FA_NAME="${{ inputs.functionapp_name }}"
          echo "ðŸš€ Deploying to $FA_NAME in $RG"
          
          # Deploy with retry logic for SCM conflicts
          MAX_RETRIES=3
          RETRY_DELAY=30
          for i in $(seq 1 $MAX_RETRIES); do
            echo "ðŸ“¤ Deployment attempt $i of $MAX_RETRIES..."
            if az functionapp deployment source config-zip \
              --resource-group "$RG" \
              --name "$FA_NAME" \
              --src backend/deploy.zip \
              --timeout 300; then
              echo "âœ… Deployment completed successfully"
              break
            else
              if [ $i -lt $MAX_RETRIES ]; then
                echo "âš ï¸ Deployment failed, waiting ${RETRY_DELAY}s before retry..."
                sleep $RETRY_DELAY
                RETRY_DELAY=$((RETRY_DELAY * 2))
              else
                echo "âŒ Deployment failed after $MAX_RETRIES attempts"
                exit 1
              fi
            fi
          done

      - name: Warm up
        run: |
          RG="${{ inputs.resource_group }}"
          FA_NAME="${{ inputs.functionapp_name }}"
          
          echo "ðŸ”„ Restarting Function App to apply settings..."
          az functionapp restart --name "$FA_NAME" --resource-group "$RG"
          
          echo "â³ Waiting for Function App to start (60s for RBAC propagation)..."
          sleep 60

      - name: Verify Functions Deployed
        run: |
          RG="${{ inputs.resource_group }}"
          FA_NAME="${{ inputs.functionapp_name }}"
          
          # Get Function App URL
          FA_URL=$(az functionapp show \
            --name "$FA_NAME" \
            --resource-group "$RG" \
            --query "defaultHostName" -o tsv)
          
          echo "ðŸ” Function App URL: https://$FA_URL"
          
          # Test health endpoint
          echo "ðŸ¥ Testing health endpoint..."
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://$FA_URL/api/health" || echo "000")
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… Health endpoint responding (HTTP $HTTP_STATUS)"
          elif [ "$HTTP_STATUS" = "404" ]; then
            echo "âš ï¸ Health endpoint not found (HTTP 404) - functions may still be loading"
          else
            echo "âš ï¸ Health endpoint returned HTTP $HTTP_STATUS"
          fi
          
          # List registered functions
          echo "ðŸ“‹ Checking registered functions..."
          FUNCTION_COUNT=$(az functionapp function list \
            --resource-group "$RG" \
            --name "$FA_NAME" \
            --query 'length(@)' -o tsv 2>/dev/null || echo "0")
          
          echo "Found $FUNCTION_COUNT functions"
          
          if [ "$FUNCTION_COUNT" -eq 0 ]; then
            echo "âš ï¸ No functions detected yet"
            echo "   This may indicate:"
            echo "   - Functions are still loading (cold start)"
            echo "   - Entry point configuration issue"
            echo "   - Check Azure Portal > Function App > Functions for details"
          else
            echo "âœ… Functions deployed successfully:"
            az functionapp function list --resource-group "$RG" --name "$FA_NAME" --query '[].name' -o tsv
          fi
