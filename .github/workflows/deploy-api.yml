name: Deploy Backend API

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-api.yml'
      - 'infra/**'
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  AZURE_FUNCTIONAPP_NAME: proteinlens-api-prod
  NODE_VERSION: '20'

jobs:
  build:
    name: Build Backend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'backend/package-lock.json'

      - name: Display versions
        run: |
          echo "Node: $(node --version)"
          echo "npm: $(npm --version)"

      - name: Install dependencies
        run: |
          cd backend
          npm ci --verbose
          echo "‚úÖ Dependencies installed"

      - name: Build TypeScript
        run: |
          cd backend
          npm run build
          echo "‚úÖ TypeScript build completed"

      - name: Run linting
        run: |
          cd backend
          npm run lint --if-present || true
          echo "‚úÖ Linting completed"

      - name: Run unit tests
        run: |
          cd backend
          npm run test --if-present || true
          echo "‚úÖ Unit tests completed"

      - name: Package Function App
        run: |
          cd backend
          # Ensure dist directory exists
          if [ ! -d "dist" ]; then
            echo "‚ùå Build output directory not found"
            exit 1
          fi
          # Create deployment package
          zip -r -q ../backend-deploy.zip dist node_modules
          ls -lh ../backend-deploy.zip
          echo "‚úÖ Function App packaged"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: backend-deploy.zip
          retention-days: 1

  deploy:
    name: Deploy to Azure Functions
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-build

      - name: Login to Azure
        env:
          AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
        run: |
          az login --service-principal \
            -u $(jq -r '.clientId' <<< '${{ secrets.AZURE_CREDENTIALS }}') \
            -p $(jq -r '.clientSecret' <<< '${{ secrets.AZURE_CREDENTIALS }}') \
            --tenant $(jq -r '.tenantId' <<< '${{ secrets.AZURE_CREDENTIALS }}')
          
          az account set --subscription $(jq -r '.subscriptionId' <<< '${{ secrets.AZURE_CREDENTIALS }}')

      - name: Deploy to Azure Functions
        uses: azure/functions-action@v1
        with:
          app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
          package: backend-deploy.zip
          publish-profile: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}
          respect-pom-xml: false

      - name: Wait for cold start
        run: |
          echo "‚è≥ Waiting for Function App cold start (10s)..."
          sleep 10
          echo "‚úÖ Cold start period complete"

  health-check:
    name: Verify Health Endpoint
    runs-on: ubuntu-latest
    needs: deploy
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Wait for deployment to stabilize
        run: |
          echo "‚è≥ Waiting for deployment to stabilize (15s)..."
          sleep 15
          echo "‚úÖ Ready for health check"

      - name: Check health endpoint
        id: health
        timeout-minutes: 3
        run: |
          HEALTH_ENDPOINT="https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net/api/health"
          MAX_RETRIES=5
          RETRY_DELAY=5
          RETRY_COUNT=0
          
          echo "üè• Checking health endpoint: $HEALTH_ENDPOINT"
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES..."
            
            HTTP_CODE=$(curl -s -o /tmp/health-response.json -w "%{http_code}" "$HEALTH_ENDPOINT")
            
            if [ "$HTTP_CODE" = "200" ]; then
              HEALTH_STATUS=$(jq -r '.status // "unknown"' /tmp/health-response.json 2>/dev/null)
              
              if [ "$HEALTH_STATUS" = "healthy" ]; then
                echo "‚úÖ Health check passed (HTTP $HTTP_CODE, status: $HEALTH_STATUS)"
                echo "health_status=healthy" >> "$GITHUB_OUTPUT"
                exit 0
              else
                echo "‚ö†Ô∏è Unhealthy response: $HEALTH_STATUS"
                cat /tmp/health-response.json
              fi
            else
              echo "‚ùå Received HTTP $HTTP_CODE"
              cat /tmp/health-response.json 2>/dev/null || echo "(no response body)"
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "Retrying in ${RETRY_DELAY}s..."
              sleep "$RETRY_DELAY"
            fi
          done
          
          echo "‚ùå Health check failed after $MAX_RETRIES attempts"
          exit 1

  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [build, deploy, health-check]
    if: always()
    steps:
      - name: Report Success
        if: success()
        run: |
          echo "## ‚úÖ Backend Deployment Successful" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Component | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-----------|--------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Build | ‚úÖ Passed |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Deploy | ‚úÖ Passed |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Health Check | ‚úÖ Passed |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Function App**: ${{ env.AZURE_FUNCTIONAPP_NAME }}" >> "$GITHUB_STEP_SUMMARY"
          echo "**URL**: https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net" >> "$GITHUB_STEP_SUMMARY"

      - name: Report Failure
        if: failure()
        run: |
          echo "## ‚ùå Backend Deployment Failed" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Check the workflow logs above for details." >> "$GITHUB_STEP_SUMMARY"
          exit 1
