name: Deploy Backend API

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-api.yml'
      - 'infra/**'
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  NODE_VERSION: '20'

jobs:
  build:
    name: Build Backend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'backend/package-lock.json'

      - name: Display versions
        run: |
          echo "Node: $(node --version)"
          echo "npm: $(npm --version)"

      - name: Install dependencies
        run: |
          cd backend
          npm ci --verbose
          echo "âœ… Dependencies installed"

      - name: Generate Prisma Client
        run: |
          cd backend
          npm run prisma:generate
          echo "âœ… Prisma client generated"

      - name: Build TypeScript
        run: |
          cd backend
          npm run build
          echo "âœ… TypeScript build completed"

      - name: Run linting
        run: |
          cd backend
          npm run lint --if-present || true
          echo "âœ… Linting completed"

      - name: Run unit tests
        run: |
          cd backend
          npm run test:unit
          echo "âœ… Unit tests completed"

      - name: Package Function App
        run: |
          cd backend
          # Ensure dist directory exists
          if [ ! -d "dist" ]; then
            echo "âŒ Build output directory not found"
            exit 1
          fi
          # Create deployment package with required files at root
          # Include prisma folder for database schema
          # Exclude dev dependencies (@types, typescript) to reduce package size
          zip -r -q ../backend-deploy.zip \
            dist \
            node_modules \
            host.json \
            package.json \
            prisma \
            -x "node_modules/@types/*" \
            -x "node_modules/typescript/*" \
            -x "*.test.js"
          ls -lh ../backend-deploy.zip
          echo "âœ… Function App packaged"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: backend-deploy.zip
          retention-days: 1

  deploy:
    name: Deploy to Azure Functions
    runs-on: ubuntu-latest
    needs: build
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-build

      - name: Login to Azure via OIDC
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Verify Function App exists
        run: |
          echo "ðŸ” Checking if Function App exists..."
          if az functionapp show --name "${{ secrets.AZURE_FUNCTIONAPP_NAME }}" --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" &> /dev/null; then
            echo "âœ… Function App '${{ secrets.AZURE_FUNCTIONAPP_NAME }}' found"
          else
            echo "âŒ Function App '${{ secrets.AZURE_FUNCTIONAPP_NAME }}' does not exist"
            echo ""
            echo "ðŸ“‹ Please deploy infrastructure first:"
            echo "   1. Go to Actions tab"
            echo "   2. Select 'Deploy Infrastructure' workflow"
            echo "   3. Click 'Run workflow'"
            echo "   4. Enter 'deploy-infra' to confirm"
            echo "   5. Select environment: prod"
            echo ""
            echo "Or run manually:"
            echo "   gh workflow run infra.yml -f environment=prod -f confirm_deploy=deploy-infra"
            exit 1
          fi

      - name: Configure Function App for ZIP deployment
        run: |
          echo "âš™ï¸ Configuring Function App for ZIP deployment..."
          az functionapp config appsettings set \
            --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" \
            --name "${{ secrets.AZURE_FUNCTIONAPP_NAME }}" \
            --settings WEBSITE_RUN_FROM_PACKAGE=1
          echo "âœ… Function App configured"

      - name: Upload and Deploy from Storage
        run: |
          echo "ðŸ“¤ Uploading deployment package to Azure Storage..."
          
          STORAGE_ACCOUNT=$(az storage account list \
            --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" \
            --query '[0].name' -o tsv)
          
          if [ -z "$STORAGE_ACCOUNT" ]; then
            echo "âŒ No storage account found"
            exit 1
          fi
          
          echo "Storage account: $STORAGE_ACCOUNT"
          
          # Create container if needed
          az storage container create \
            --account-name "$STORAGE_ACCOUNT" \
            --name deployments \
            --auth-mode login 2>/dev/null || true
          
          # Upload ZIP with timestamp using managed identity login
          TIMESTAMP=$(date +%s)
          BLOB_NAME="backend-${TIMESTAMP}.zip"
          
          az storage blob upload \
            --account-name "$STORAGE_ACCOUNT" \
            --container-name deployments \
            --name "$BLOB_NAME" \
            --file backend-deploy.zip \
            --auth-mode login
          
          echo "âœ… ZIP uploaded to storage: $BLOB_NAME"
          
          # Generate SAS URL valid for 1 hour using login mode
          SAS_TOKEN=$(az storage blob generate-sas \
            --account-name "$STORAGE_ACCOUNT" \
            --container-name deployments \
            --name "$BLOB_NAME" \
            --permissions r \
            --expiry $(date -u -d '+1 hour' '+%Y-%m-%dT%H:%MZ') \
            --auth-mode login -o tsv)
          
          PACKAGE_URL="https://${STORAGE_ACCOUNT}.blob.core.windows.net/deployments/${BLOB_NAME}?${SAS_TOKEN}"
          
          echo "ðŸ“¦ Setting package URL for Function App..."
          
          az functionapp config appsettings set \
            --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" \
            --name "${{ secrets.AZURE_FUNCTIONAPP_NAME }}" \
            --settings WEBSITE_RUN_FROM_PACKAGE="${PACKAGE_URL}"
          
          echo "âœ… Function App configured with package URL"
          echo "â³ Waiting for deployment to complete (30s)..."
          sleep 30
          
      - name: Verify Functions Deployed
        run: |
          echo "ðŸ” Verifying functions deployed..."
          FUNCTION_COUNT=$(az functionapp function list \
            --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" \
            --name "${{ secrets.AZURE_FUNCTIONAPP_NAME }}" \
            --query 'length(@)' -o tsv)
          
          echo "Found $FUNCTION_COUNT functions"
          if [ "$FUNCTION_COUNT" -eq 0 ]; then
            echo "âŒ ERROR: No functions deployed!"
            echo "Listing deployed functions:"
            az functionapp function list \
              --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" \
              --name "${{ secrets.AZURE_FUNCTIONAPP_NAME }}"
            exit 1
          else
            echo "âœ… Functions deployed successfully"
            az functionapp function list \
              --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" \
              --name "${{ secrets.AZURE_FUNCTIONAPP_NAME }}" \
              --query '[].name' -o tsv
          fi

      - name: Test Health Endpoint
        run: |
          echo "ðŸ§ª Testing Function App health endpoint..."
          for i in {1..5}; do
            echo "Attempt $i/5..."
            HTTP_CODE=$(curl -s -w "%{http_code}" -o /dev/null \
              "https://${{ secrets.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net/api/health")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Health endpoint responding with 200"
              exit 0
            fi
            echo "Got HTTP $HTTP_CODE, retrying..."
            if [ $i -lt 5 ]; then sleep 10; fi
          done
          echo "âš ï¸ Health endpoint not ready yet (may be cold starting)"

  health-check:
    name: Verify Health Endpoint
    runs-on: ubuntu-latest
    needs: deploy
    timeout-minutes: 5
    continue-on-error: true  # Don't fail deployment if health check fails
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Wait for deployment to stabilize
        run: |
          echo "â³ Waiting for deployment to stabilize (15s)..."
          sleep 15
          echo "âœ… Ready for health check"

      - name: Check health endpoint
        id: health
        timeout-minutes: 3
        run: |
          HEALTH_ENDPOINT="https://${{ secrets.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net/api/health"
          MAX_RETRIES=5
          RETRY_DELAY=5
          RETRY_COUNT=0
          
          echo "ðŸ¥ Checking health endpoint: $HEALTH_ENDPOINT"
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES..."
            
            HTTP_CODE=$(curl -s -o /tmp/health-response.json -w "%{http_code}" "$HEALTH_ENDPOINT")
            
            if [ "$HTTP_CODE" = "200" ]; then
              HEALTH_STATUS=$(jq -r '.status // "unknown"' /tmp/health-response.json 2>/dev/null)
              
              if [ "$HEALTH_STATUS" = "healthy" ]; then
                echo "âœ… Health check passed (HTTP $HTTP_CODE, status: $HEALTH_STATUS)"
                echo "health_status=healthy" >> "$GITHUB_OUTPUT"
                exit 0
              else
                echo "âš ï¸ Unhealthy response: $HEALTH_STATUS"
                cat /tmp/health-response.json
              fi
            else
              echo "âŒ Received HTTP $HTTP_CODE"
              cat /tmp/health-response.json 2>/dev/null || echo "(no response body)"
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "Retrying in ${RETRY_DELAY}s..."
              sleep "$RETRY_DELAY"
            fi
          done
          
          echo "âŒ Health check failed after $MAX_RETRIES attempts"
          exit 1

  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [build, deploy, health-check]
    if: always()
    steps:
      - name: Report Success
        if: success()
        run: |
          echo "## âœ… Backend Deployment Successful" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Component | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-----------|--------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Build | âœ… Passed |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Deploy | âœ… Passed |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Health Check | âœ… Passed |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Function App**: ${{ secrets.AZURE_FUNCTIONAPP_NAME }}" >> "$GITHUB_STEP_SUMMARY"
          echo "**URL**: https://${{ secrets.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net" >> "$GITHUB_STEP_SUMMARY"

      - name: Report Failure
        if: failure()
        run: |
          echo "## âŒ Backend Deployment Failed" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Check the workflow logs above for details." >> "$GITHUB_STEP_SUMMARY"
          exit 1
