name: Deploy Backend API

on:
  workflow_call:
    inputs:
      resource_group:
        description: 'Azure Resource Group'
        required: true
        type: string
      functionapp_name:
        description: 'Azure Function App Name'
        required: true
        type: string

permissions:
  contents: read
  id-token: write

env:
  NODE_VERSION: '20'

jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'backend/package-lock.json'

      - name: Display versions
        run: |
          echo "Node: $(node --version)"
          echo "npm: $(npm --version)"

      - name: Install dependencies
        run: |
          cd backend
          npm ci --verbose
          echo "‚úÖ Dependencies installed"

      - name: Generate Prisma Client
        run: |
          cd backend
          npm run prisma:generate
          echo "‚úÖ Prisma client generated"

      - name: Build TypeScript
        run: |
          cd backend
          npm run build
          echo "‚úÖ TypeScript build completed"

      - name: Run unit tests
        run: |
          cd backend
          npm run test:unit || echo "‚ö†Ô∏è Unit tests skipped or failed"
          echo "‚úÖ Tests completed"

      - name: Package Function App
        run: |
          cd backend
          # Validate host.json exists
          if [ ! -f "host.json" ]; then
            echo "‚ùå host.json missing at backend/"
            exit 1
          fi
          # Ensure dist directory exists
          if [ ! -d "dist" ]; then
            echo "‚ùå Build output directory not found"
            exit 1
          fi
          # Stage a deployable Functions app
          rm -rf .deploy && mkdir -p .deploy
          cp host.json .deploy/
          cp -r prisma .deploy/prisma
          cp -r node_modules .deploy/node_modules
          # Copy dist folder preserving structure (package.json main points to dist/index.js)
          cp -r dist .deploy/dist
          # Create production package.json with correct main entry
          cat package.json | jq 'del(.devDependencies) | .main = "dist/index.js"' > .deploy/package.json
          echo "‚úÖ Deployment folder prepared at backend/.deploy"
          echo "üìÅ Structure:"
          find .deploy -maxdepth 2 -type f | head -20
          echo "üìÑ package.json main entry:"
          cat .deploy/package.json | jq '.main'

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Verify Function App exists
        run: |
          RG="${{ inputs.resource_group }}"
          FA_NAME="${{ inputs.functionapp_name }}"
          echo "üîç Checking Function App: $FA_NAME in RG: $RG"
          if az functionapp show --name "$FA_NAME" --resource-group "$RG" &> /dev/null; then
            echo "‚úÖ Function App found"
          else
            echo "‚ùå Function App not found"
            exit 1
          fi

      - name: Create deployment zip
        run: |
          cd backend/.deploy
          zip -r ../deploy.zip .
          ls -la ../deploy.zip
          echo "‚úÖ Created deploy.zip"

      - name: Deploy to Azure Functions
        run: |
          RG="${{ inputs.resource_group }}"
          FA_NAME="${{ inputs.functionapp_name }}"
          echo "üöÄ Deploying to $FA_NAME in $RG"
          az functionapp deployment source config-zip \
            --resource-group "$RG" \
            --name "$FA_NAME" \
            --src backend/deploy.zip
          echo "‚úÖ Deployment completed"

      - name: Warm up
        run: |
          echo "‚è≥ Waiting for deployment to complete (30s)..."
          sleep 30

      - name: Verify Functions Deployed
        run: |
          RG="${{ inputs.resource_group }}"
          FA_NAME="${{ inputs.functionapp_name }}"
          FUNCTION_COUNT=$(az functionapp function list \
            --resource-group "$RG" \
            --name "$FA_NAME" \
            --query 'length(@)' -o tsv 2>/dev/null || echo "0")
          echo "Found $FUNCTION_COUNT functions"
          if [ "$FUNCTION_COUNT" -eq 0 ]; then
            echo "‚ö†Ô∏è No functions detected yet (may be cold starting)"
          else
            echo "‚úÖ Functions deployed successfully"
            az functionapp function list --resource-group "$RG" --name "$FA_NAME" --query '[].name' -o tsv
          fi
