name: Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write
  security-events: write

env:
  RESOURCE_GROUP: proteinlens-prod

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  cleanup_artifacts:
    name: Cleanup Old Artifacts
    runs-on: ubuntu-latest
    steps:
      - name: Delete old artifacts (keep last 5)
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const keepCount = 5;
            
            console.log(`ðŸ§¹ Cleaning up artifacts for ${owner}/${repo}, keeping last ${keepCount}...`);
            
            try {
              // Get all artifacts
              const artifacts = await github.paginate(
                github.rest.actions.listArtifactsForRepo,
                { owner, repo, per_page: 100 }
              );
              
              console.log(`Found ${artifacts.length} total artifacts`);
              
              // Group by name
              const byName = {};
              for (const artifact of artifacts) {
                if (!byName[artifact.name]) {
                  byName[artifact.name] = [];
                }
                byName[artifact.name].push(artifact);
              }
              
              // For each group, sort by date and delete old ones
              let deleted = 0;
              for (const [name, group] of Object.entries(byName)) {
                // Sort by created_at descending (newest first)
                group.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                
                // Delete all except the newest keepCount
                const toDelete = group.slice(keepCount);
                for (const artifact of toDelete) {
                  try {
                    await github.rest.actions.deleteArtifact({
                      owner,
                      repo,
                      artifact_id: artifact.id
                    });
                    deleted++;
                    console.log(`âœ“ Deleted: ${artifact.name} (${artifact.id}) from ${artifact.created_at}`);
                  } catch (e) {
                    console.log(`âœ— Failed to delete ${artifact.id}: ${e.message}`);
                  }
                }
              }
              
              console.log(`\nâœ… Cleanup complete: deleted ${deleted} old artifacts`);
            } catch (error) {
              console.log(`âš ï¸ Artifact cleanup failed: ${error.message}`);
              // Don't fail the workflow if cleanup fails
            }

  secret_scan:
    name: Secret Scanning
    needs: [cleanup_artifacts]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comprehensive scan

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Temporarily disabled until storage quota recalculates (6-12 hours)
          # Re-enable after quota resets
          GITLEAKS_ENABLE_UPLOAD_ARTIFACT: false
          GITLEAKS_ENABLE_SUMMARY: false

      - name: Check for hardcoded API keys
        run: |
          echo "Scanning for common secret patterns..."
          
          # OpenAI API key pattern
          if git grep -E 'sk-[A-Za-z0-9]{32,}' -- '*.ts' '*.js' '*.json' '*.yml' '*.yaml' 2>/dev/null; then
            echo "âŒ FAIL: OpenAI API key pattern detected"
            exit 1
          fi
          
          # Azure Cognitive Services key pattern
          if git grep -E '[0-9a-f]{32}' -- '*.ts' '*.js' 2>/dev/null | grep -i 'key'; then
            echo "âš ï¸ WARNING: Potential Azure key pattern detected"
            echo "Review matches above to ensure they are not secrets"
          fi
          
          # Generic API key assignments
          if git grep -E '(apiKey|api_key|API_KEY)\s*=\s*["\x27][A-Za-z0-9+/=]{20,}["\x27]' -- '*.ts' '*.js' 2>/dev/null; then
            echo "âŒ FAIL: Hardcoded API key assignment detected"
            exit 1
          fi
          
          echo "âœ… PASS: No obvious secrets detected"

      - name: Check for Key Vault reference usage
        run: |
          echo "Verifying Key Vault references in config files..."
          
          # Check GitHub Actions workflows use Key Vault patterns
          if grep -r 'AZURE_OPENAI_API_KEY' .github/workflows/ 2>/dev/null | grep -v '@Microsoft.KeyVault'; then
            echo "âš ï¸ WARNING: AZURE_OPENAI_API_KEY used without Key Vault reference"
          fi
          
          # Check Bicep files use Key Vault references
          if grep -r 'OPENAI.*API.*KEY' infra/bicep/ 2>/dev/null | grep -v 'KeyVault' | grep -v 'keyvault'; then
            echo "âš ï¸ WARNING: OpenAI key referenced in Bicep without Key Vault"
          fi
          
          echo "âœ… Key Vault reference check complete"

      - name: Validate script safety
        run: |
          echo "Checking scripts avoid logging secrets..."
          
          # Check scripts use silent modes
          if grep -E 'echo.*\$.*KEY' scripts/foundry-*.sh 2>/dev/null; then
            echo "âŒ FAIL: Script echoes variable that may contain key"
            exit 1
          fi
          
          # Verify --output none usage for sensitive commands
          if [ -f scripts/foundry-up.sh ] && ! grep -q 'keyvault secret set.*--output none' scripts/foundry-up.sh; then
            echo "âš ï¸ WARNING: Key Vault secret set may log output"
          fi
          
          echo "âœ… Script safety check complete"

  dns_gate:
    name: Production DNS Gate
    needs: [secret_scan]
    runs-on: ubuntu-latest
    outputs:
      ok: ${{ steps.gate.outputs.ok || steps.gateprod.outputs.ok }}
    steps:
      - name: Non-production branch
        if: github.ref != 'refs/heads/main'
        id: gate
        run: |
          echo "ok=true" >> "$GITHUB_OUTPUT"
          echo "âœ… Non-production branch; DNS gate passed"

      - name: Azure Login (OIDC)
        if: github.ref == 'refs/heads/main'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Check Azure DNS zone
        if: github.ref == 'refs/heads/main'
        run: |
          ZONE="${{ vars.DNS_ZONE_NAME }}"
          [ -z "$ZONE" ] && ZONE="proteinlens.com"
          RG="${{ vars.AZURE_DNS_RESOURCE_GROUP }}"
          if [ -z "$RG" ]; then
            echo "âŒ AZURE_DNS_RESOURCE_GROUP not set"
            exit 1
          fi
          if az network dns zone show -g "$RG" -n "$ZONE" &>/dev/null; then
            echo "âœ… DNS zone '$ZONE' found"
          else
            echo "âŒ DNS zone '$ZONE' not found"
            exit 2
          fi

      - name: Set DNS gate output
        if: github.ref == 'refs/heads/main' && success()
        id: gateprod
        run: |
          echo "ok=true" >> "$GITHUB_OUTPUT"
          echo "âœ… Production DNS gate passed"

  infra:
    name: Provision Infra
    needs: [dns_gate]
    if: needs.dns_gate.outputs.ok == 'true'
    uses: ./.github/workflows/infra.yml
    secrets: inherit
    with:
      environment: prod

  deploy_backend:
    name: Deploy Backend
    needs: [infra, dns_gate]
    if: always() && needs.infra.result == 'success' && needs.dns_gate.outputs.ok == 'true'
    uses: ./.github/workflows/deploy-api.yml
    secrets: inherit
    with:
      resource_group: proteinlens-prod
      functionapp_name: ${{ needs.infra.outputs.functionapp_name }}

  deploy_frontend:
    name: Deploy Frontend
    needs: [infra, dns_gate]
    if: always() && needs.infra.result == 'success' && needs.dns_gate.outputs.ok == 'true'
    uses: ./.github/workflows/deploy-web.yml
    secrets: inherit
    with:
      resource_group: proteinlens-prod
      staticwebapp_name: ${{ needs.infra.outputs.staticwebapp_name }}
      api_url: ${{ needs.infra.outputs.functionapp_url }}

  health_check:
    name: Health Checks
    needs: [infra, deploy_backend, deploy_frontend]
    if: always() && (needs.deploy_backend.result == 'success' || needs.deploy_frontend.result == 'success')
    runs-on: ubuntu-latest
    steps:
      - name: API health check (/api/health -> 200)
        run: |
          URL="${{ needs.infra.outputs.functionapp_url }}/api/health"
          echo "ðŸ” Testing API health: $URL"
          for i in $(seq 1 5); do
            code=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$URL" || true)
            echo "Attempt $i: HTTP $code"
            if [ "$code" = "200" ]; then
              echo "âœ… API health check passed"
              exit 0
            fi
            sleep 5
          done
          echo "âŒ API health check failed after 5 attempts"
          exit 1

      - name: Frontend check (index.html -> 200)
        run: |
          URL="${{ needs.infra.outputs.staticwebapp_url }}"
          echo "ðŸ” Testing frontend: $URL"
          for i in $(seq 1 5); do
            code=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$URL" || true)
            echo "Attempt $i: HTTP $code"
            if [ "$code" = "200" ]; then
              echo "âœ… Frontend check passed"
              exit 0
            fi
            sleep 5
          done
          echo "âŒ Frontend check failed after 5 attempts"
          exit 1

  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [secret_scan, dns_gate, infra, deploy_backend, deploy_frontend, health_check]
    if: always()
    steps:
      - name: Summarize results
        run: |
          echo "## ðŸ“‹ Deployment Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "| Component | Result |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-----------|--------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Secret Scan | ${{ needs.secret_scan.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| DNS Gate | ${{ needs.dns_gate.outputs.ok || 'false' }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Infra | ${{ needs.infra.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Backend | ${{ needs.deploy_backend.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Frontend | ${{ needs.deploy_frontend.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Health Checks | ${{ needs.health_check.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Endpoints" >> "$GITHUB_STEP_SUMMARY"
          echo "- API: ${{ needs.infra.outputs.functionapp_url }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Web: ${{ needs.infra.outputs.staticwebapp_url }}" >> "$GITHUB_STEP_SUMMARY"
