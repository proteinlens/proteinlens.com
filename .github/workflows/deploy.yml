name: Deploy

on:
  push:
    branches: [ main ]

permissions:
  contents: read

env:
  AZURE_WHAT_IF: ${{ vars.AZURE_WHAT_IF || 'false' }}

jobs:
  infra:
    name: Infra
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Azure CLI version
        uses: azure/cli@v2
        with:
          inlineScript: az version

      - name: Validate Azure DNS zone in prod
        if: github.ref == 'refs/heads/main'
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -euo pipefail
            RG="${{ vars.AZURE_RESOURCE_GROUP }}"
            ZONE="${{ vars.DNS_ZONE_NAME }}"
            if ! az network dns zone show -n "$ZONE" -g "$RG" >/dev/null 2>&1; then
              echo "Move DNS zone to Azure DNS to enable zero-touch domains" >&2
              exit 16
            fi
            echo "DNS zone $ZONE found in resource group $RG"

      - name: Deploy Bicep (idempotent)
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -euo pipefail
            RG="${{ vars.AZURE_RESOURCE_GROUP }}"
            LOCATION="${{ vars.AZURE_LOCATION }}"
            ENVIRONMENT_NAME=prod
            # Note: location param is @allowed([northeurope]) in Bicep
            az group create -n "$RG" -l "$LOCATION"
            DNS_EXISTS=true
            # Optional preview of changes
            if [ "${AZURE_WHAT_IF}" = "true" ]; then
              az deployment group what-if \
                --resource-group "$RG" \
                --template-file infra/bicep/main.bicep \
                --parameters \
                  location=northeurope \
                  environmentName=$ENVIRONMENT_NAME \
                  isProd=true \
                  dnsZoneName=${{ vars.DNS_ZONE_NAME }} \
                  dnsZoneExists=$DNS_EXISTS || true
            fi
            az deployment group create \
              --resource-group "$RG" \
              --template-file infra/bicep/main.bicep \
              --parameters \
                location=northeurope \
                environmentName=$ENVIRONMENT_NAME \
                isProd=true \
                dnsZoneName=${{ vars.DNS_ZONE_NAME }} \
                dnsZoneExists=$DNS_EXISTS

  deploy_backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    needs: [infra]
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Build and Package Functions
        run: |
          set -euo pipefail
          pushd backend
          npm ci
          npm run build --if-present || true
          zip -r ../backend.zip . -x "node_modules/*" -x ".*" -x "tests/*"
          popd

      - name: Preflight: host.json at zip root
        run: |
          set -euo pipefail
          unzip -l backend.zip | awk '{print $4}' | grep -E '^host.json$' >/dev/null || { echo "backend.zip missing host.json at root" >&2; exit 17; }

      - name: Deploy Functions (zip)
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -euo pipefail
            az functionapp deployment source config-zip \
              -g "${{ vars.AZURE_RESOURCE_GROUP }}" \
              -n "${{ vars.FUNCTION_APP_NAME }}" \
              --src backend.zip

  deploy_frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: [infra]
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Build Frontend
        run: |
          set -euo pipefail
          pushd frontend
          npm ci
          npm run build
          test -f dist/index.html || { echo "frontend/dist/index.html missing" >&2; exit 18; }
          popd

      - name: Fetch SWA deploy token
        id: token
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -euo pipefail
            TOKEN=$(az staticwebapp secrets list --name "${{ vars.STATIC_WEB_APP_NAME }}" --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" --query properties.apiKey -o tsv)
            if [ -z "$TOKEN" ]; then echo "Failed to retrieve SWA token" >&2; exit 19; fi
            echo "token=$TOKEN" >> $GITHUB_OUTPUT

      - name: Deploy Static Web App
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ steps.token.outputs.token }}
          skip_app_build: true
          app_location: frontend
          output_location: dist

  smoke_test:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: [deploy_backend, deploy_frontend]
    steps:
      - name: API health with retry/backoff
        run: |
          set -euo pipefail
          URL="https://api.proteinlens.com/api/health"
          for i in $(seq 1 10); do
            code=$(curl -s -o /dev/null -w "%{http_code}" "$URL" || true)
            if [ "$code" = "200" ]; then echo "API OK"; exit 0; fi
            S=$(( 2**i )); [ $S -gt 30 ] && S=30; sleep $S
          done
          echo "API health check failed" >&2
          exit 20

      - name: Web check with title marker and retry/backoff
        run: |
          set -euo pipefail
          URL="https://www.proteinlens.com/"
          for i in $(seq 1 10); do
            body=$(curl -fsS "$URL" || true)
            if echo "$body" | grep -q "<title>ProteinLens</title>"; then echo "WEB OK"; exit 0; fi
            S=$(( 2**i )); [ $S -gt 30 ] && S=30; sleep $S
          done
          echo "Web check failed" >&2
          exit 21
