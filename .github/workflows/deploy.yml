name: Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

env:
  AZURE_WHAT_IF: ${{ vars.AZURE_WHAT_IF }}

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    name: Detect Changed Paths
    runs-on: ubuntu-latest
    outputs:
      infra: ${{ steps.filter.outputs.infra }}
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Paths filter
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            infra:
              - 'infra/**'
            backend:
              - 'backend/**'
            frontend:
              - 'frontend/**'

  dns_gate:
    name: Production DNS Gate
    runs-on: ubuntu-latest
    needs: [changes]
    outputs:
      ok: ${{ steps.gate.outputs.ok }}
    steps:
      - name: Non-production branch
        if: github.ref != 'refs/heads/main'
        id: gate
        run: |
          echo "ok=true" >> "$GITHUB_OUTPUT"
          echo "âœ… Non-production branch; DNS gate passed by default"

      - name: Azure Login (OIDC)
        if: github.ref == 'refs/heads/main'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Check Azure DNS zone (proteinlens.com)
        if: github.ref == 'refs/heads/main'
        id: checkdns
        run: |
          set -euo pipefail
          ZONE="${{ vars.DNS_ZONE_NAME }}"
          [ -z "$ZONE" ] && ZONE="proteinlens.com"
          RG="${{ vars.AZURE_DNS_RESOURCE_GROUP }}"
          if [ -z "$RG" ]; then
            echo "âŒ AZURE_DNS_RESOURCE_GROUP repo variable is not set."
            echo "Please set repository variable AZURE_DNS_RESOURCE_GROUP to the resource group that contains the DNS zone '$ZONE'."
            exit 1
          fi
          echo "ðŸ”Ž Checking DNS zone '$ZONE' in resource group '$RG'..."
          if az network dns zone show -g "$RG" -n "$ZONE" &>/dev/null; then
            echo "âœ… DNS zone '$ZONE' found"
          else
            echo "âŒ DNS zone '$ZONE' not found in resource group '$RG'"
            exit 2
          fi

      - name: Set DNS gate output
        if: github.ref == 'refs/heads/main' && success()
        id: gateprod
        run: |
          echo "ok=true" >> "$GITHUB_OUTPUT"
          echo "âœ… Production DNS gate passed"
          echo "## âœ… DNS Gate Passed" >> "$GITHUB_STEP_SUMMARY"
          echo "Zone: ${{ vars.DNS_ZONE_NAME || 'proteinlens.com' }}" >> "$GITHUB_STEP_SUMMARY"
          echo "Resource Group: ${{ vars.AZURE_DNS_RESOURCE_GROUP }}" >> "$GITHUB_STEP_SUMMARY"

      - name: Report DNS gate failure
        if: github.ref == 'refs/heads/main' && failure()
        run: |
          echo "ok=false" >> "$GITHUB_OUTPUT"
          echo "## âŒ Production DNS Zone Missing" >> "$GITHUB_STEP_SUMMARY"
          echo "Production runs require Azure DNS zone for 'proteinlens.com'." >> "$GITHUB_STEP_SUMMARY"
          echo "Set repo variables: AZURE_DNS_RESOURCE_GROUP and DNS_ZONE_NAME (default: proteinlens.com)." >> "$GITHUB_STEP_SUMMARY"
          exit 1

  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [changes, dns_gate, infra, deploy_backend, deploy_frontend, smoke_test]
    if: always()
    steps:
      - name: Summarize results
        run: |
          echo "## ðŸ“‹ Orchestrator Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Gate" >> "$GITHUB_STEP_SUMMARY"
          echo "DNS Gate: ${{ needs.dns_gate.outputs.ok || 'false' }}" >> "$GITHUB_STEP_SUMMARY"
          echo "Zone: ${{ vars.DNS_ZONE_NAME || 'proteinlens.com' }}" >> "$GITHUB_STEP_SUMMARY"
          echo "DNS RG: ${{ vars.AZURE_DNS_RESOURCE_GROUP || 'unset' }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Changes" >> "$GITHUB_STEP_SUMMARY"
          echo "Infra changed: ${{ needs.changes.outputs.infra }}" >> "$GITHUB_STEP_SUMMARY"
          echo "Backend changed: ${{ needs.changes.outputs.backend }}" >> "$GITHUB_STEP_SUMMARY"
          echo "Frontend changed: ${{ needs.changes.outputs.frontend }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Deploy Results" >> "$GITHUB_STEP_SUMMARY"
          echo "Backend deploy: ${{ needs.deploy_backend.result }}" >> "$GITHUB_STEP_SUMMARY"
          echo "Frontend deploy: ${{ needs.deploy_frontend.result }}" >> "$GITHUB_STEP_SUMMARY"
          echo "Smoke tests: ${{ needs.smoke_test.result }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Endpoints" >> "$GITHUB_STEP_SUMMARY"
          echo "API URL: ${{ needs.infra.outputs.functionapp_url }}" >> "$GITHUB_STEP_SUMMARY"
          echo "Web URL: https://${{ needs.infra.outputs.staticwebapp_name }}.azurestaticapps.net/" >> "$GITHUB_STEP_SUMMARY"

  test:
    name: Pre-Deploy Tests
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.backend == 'true' || needs.changes.outputs.frontend == 'true'
    steps:
      - name: Backend tests
        run: |
          cd backend
          npm ci
          npm run test:unit
      - name: Frontend tests
        run: |
          cd frontend
          npm ci
          npm test -- --coverage || true

  infra:
    name: Provision Infra
    needs: [changes, test]
    uses: ./.github/workflows/infra.yml
    with:
      environment: prod

  deploy_backend:
    name: Deploy Backend
    needs: [infra, dns_gate, changes]
    if: needs.changes.outputs.backend == 'true' && needs.dns_gate.outputs.ok == 'true'
    uses: ./.github/workflows/deploy-api.yml
    with:
      resource_group: ${{ vars.AZURE_RESOURCE_GROUP }}
      functionapp_name: ${{ needs.infra.outputs.functionapp_name }}
      # database_url can be passed if needed

  deploy_frontend:
    name: Deploy Frontend
    needs: [infra, dns_gate, changes]
    if: needs.changes.outputs.frontend == 'true' && needs.dns_gate.outputs.ok == 'true'
    uses: ./.github/workflows/deploy-web.yml
    with:
      resource_group: ${{ vars.AZURE_RESOURCE_GROUP }}
      staticwebapp_name: ${{ needs.infra.outputs.staticwebapp_name }}
      api_url: ${{ needs.infra.outputs.functionapp_url }}

  smoke_test:
    name: Smoke Tests
    needs: [deploy_backend, deploy_frontend]
    if: needs.changes.outputs.backend == 'true' || needs.changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: API health with retry/backoff
        run: |
          set -euo pipefail
          URL="${{ needs.infra.outputs.functionapp_url }}/api/health"
          for i in $(seq 1 10); do
            code=$(curl -s -o /dev/null -w "%{http_code}" "$URL" || true)
            if [ "$code" = "200" ]; then echo "API OK"; exit 0; fi
            S=$(( 2**i )); [ $S -gt 30 ] && S=30; sleep $S
          done
          echo "API health check failed" >&2
          exit 20

      - name: Web check with title marker and retry/backoff
        run: |
          set -euo pipefail
          URL="https://${{ needs.infra.outputs.staticwebapp_name }}.azurestaticapps.net/"
          for i in $(seq 1 10); do
            body=$(curl -fsS "$URL" || true)
            if echo "$body" | grep -q "ProteinLens"; then echo "WEB OK"; exit 0; fi
            S=$(( 2**i )); [ $S -gt 30 ] && S=30; sleep $S
          done
          echo "Web check failed" >&2
          exit 21
