name: Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  AZURE_WHAT_IF: ${{ vars.AZURE_WHAT_IF }}
  RESOURCE_GROUP: proteinlens-prod

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    name: Detect Changed Paths
    runs-on: ubuntu-latest
    outputs:
      infra: ${{ steps.filter.outputs.infra }}
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Paths filter
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            infra:
              - 'infra/**'
            backend:
              - 'backend/**'
            frontend:
              - 'frontend/**'

  dns_gate:
    name: Production DNS Gate
    runs-on: ubuntu-latest
    needs: [changes]
    outputs:
      ok: ${{ steps.gate.outputs.ok || steps.gateprod.outputs.ok }}
    steps:
      - name: Non-production branch
        if: github.ref != 'refs/heads/main'
        id: gate
        run: |
          echo "ok=true" >> "$GITHUB_OUTPUT"
          echo "âœ… Non-production branch; DNS gate passed by default"

      - name: Azure Login (OIDC)
        if: github.ref == 'refs/heads/main'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Check Azure DNS zone (proteinlens.com)
        if: github.ref == 'refs/heads/main'
        id: checkdns
        run: |
          set -euo pipefail
          ZONE="${{ vars.DNS_ZONE_NAME }}"
          [ -z "$ZONE" ] && ZONE="proteinlens.com"
          RG="${{ vars.AZURE_DNS_RESOURCE_GROUP }}"
          if [ -z "$RG" ]; then
            echo "âŒ AZURE_DNS_RESOURCE_GROUP repo variable is not set."
            exit 1
          fi
          echo "ðŸ”Ž Checking DNS zone '$ZONE' in resource group '$RG'..."
          if az network dns zone show -g "$RG" -n "$ZONE" &>/dev/null; then
            echo "âœ… DNS zone '$ZONE' found"
          else
            echo "âŒ DNS zone '$ZONE' not found in resource group '$RG'"
            exit 2
          fi

      - name: Set DNS gate output
        if: github.ref == 'refs/heads/main' && success()
        id: gateprod
        run: |
          echo "ok=true" >> "$GITHUB_OUTPUT"
          echo "âœ… Production DNS gate passed"

      - name: Report DNS gate failure
        if: github.ref == 'refs/heads/main' && failure()
        run: |
          echo "âŒ Production DNS Zone Missing"
          exit 1

  infra:
    name: Provision Infra
    needs: [changes, dns_gate]
    if: needs.dns_gate.outputs.ok == 'true'
    uses: ./.github/workflows/infra.yml
    secrets: inherit
    with:
      environment: prod

  deploy_backend:
    name: Deploy Backend
    needs: [infra, dns_gate, changes]
    if: always() && needs.infra.result == 'success' && needs.dns_gate.outputs.ok == 'true'
    uses: ./.github/workflows/deploy-api.yml
    secrets: inherit
    with:
      resource_group: proteinlens-prod
      functionapp_name: ${{ needs.infra.outputs.functionapp_name }}

  deploy_frontend:
    name: Deploy Frontend
    needs: [infra, dns_gate, changes]
    if: always() && needs.infra.result == 'success' && needs.dns_gate.outputs.ok == 'true'
    uses: ./.github/workflows/deploy-web.yml
    secrets: inherit
    with:
      resource_group: proteinlens-prod
      staticwebapp_name: ${{ needs.infra.outputs.staticwebapp_name }}
      api_url: ${{ needs.infra.outputs.functionapp_url }}

  smoke_test:
    name: Smoke Tests
    needs: [infra, deploy_backend, deploy_frontend]
    if: always() && (needs.deploy_backend.result == 'success' || needs.deploy_frontend.result == 'success')
    runs-on: ubuntu-latest
    steps:
      - name: API health check
        run: |
          URL="${{ needs.infra.outputs.functionapp_url }}/api/health"
          for i in $(seq 1 10); do
            code=$(curl -s -o /dev/null -w "%{http_code}" "$URL" || true)
            if [ "$code" = "200" ]; then echo "API OK"; exit 0; fi
            sleep $((2**i > 30 ? 30 : 2**i))
          done
          echo "API health check failed" && exit 20

      - name: Web check
        run: |
          URL="${{ needs.infra.outputs.staticwebapp_url }}"
          for i in $(seq 1 10); do
            body=$(curl -fsS "$URL" 2>/dev/null || true)
            if echo "$body" | grep -qi "protein\|lens"; then echo "WEB OK"; exit 0; fi
            sleep $((2**i > 30 ? 30 : 2**i))
          done
          echo "Web check failed" && exit 21

  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [changes, dns_gate, infra, deploy_backend, deploy_frontend, smoke_test]
    if: always()
    steps:
      - name: Summarize results
        run: |
          echo "## ðŸ“‹ Deployment Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "| Component | Result |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-----------|--------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| DNS Gate | ${{ needs.dns_gate.outputs.ok || 'false' }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Infra | ${{ needs.infra.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Backend | ${{ needs.deploy_backend.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Frontend | ${{ needs.deploy_frontend.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Smoke Tests | ${{ needs.smoke_test.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Endpoints" >> "$GITHUB_STEP_SUMMARY"
          echo "- API: ${{ needs.infra.outputs.functionapp_url }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Web: ${{ needs.infra.outputs.staticwebapp_url }}" >> "$GITHUB_STEP_SUMMARY"
