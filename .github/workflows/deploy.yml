name: Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  RESOURCE_GROUP: proteinlens-prod

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  dns_gate:
    name: Production DNS Gate
    runs-on: ubuntu-latest
    outputs:
      ok: ${{ steps.gate.outputs.ok || steps.gateprod.outputs.ok }}
    steps:
      - name: Non-production branch
        if: github.ref != 'refs/heads/main'
        id: gate
        run: |
          echo "ok=true" >> "$GITHUB_OUTPUT"
          echo "âœ… Non-production branch; DNS gate passed"

      - name: Azure Login (OIDC)
        if: github.ref == 'refs/heads/main'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Check Azure DNS zone
        if: github.ref == 'refs/heads/main'
        run: |
          ZONE="${{ vars.DNS_ZONE_NAME }}"
          [ -z "$ZONE" ] && ZONE="proteinlens.com"
          RG="${{ vars.AZURE_DNS_RESOURCE_GROUP }}"
          if [ -z "$RG" ]; then
            echo "âŒ AZURE_DNS_RESOURCE_GROUP not set"
            exit 1
          fi
          if az network dns zone show -g "$RG" -n "$ZONE" &>/dev/null; then
            echo "âœ… DNS zone '$ZONE' found"
          else
            echo "âŒ DNS zone '$ZONE' not found"
            exit 2
          fi

      - name: Set DNS gate output
        if: github.ref == 'refs/heads/main' && success()
        id: gateprod
        run: |
          echo "ok=true" >> "$GITHUB_OUTPUT"
          echo "âœ… Production DNS gate passed"

  infra:
    name: Provision Infra
    needs: [dns_gate]
    if: needs.dns_gate.outputs.ok == 'true'
    uses: ./.github/workflows/infra.yml
    secrets: inherit
    with:
      environment: prod

  deploy_backend:
    name: Deploy Backend
    needs: [infra, dns_gate]
    if: always() && needs.infra.result == 'success' && needs.dns_gate.outputs.ok == 'true'
    uses: ./.github/workflows/deploy-api.yml
    secrets: inherit
    with:
      resource_group: proteinlens-prod
      functionapp_name: ${{ needs.infra.outputs.functionapp_name }}

  deploy_frontend:
    name: Deploy Frontend
    needs: [infra, dns_gate]
    if: always() && needs.infra.result == 'success' && needs.dns_gate.outputs.ok == 'true'
    uses: ./.github/workflows/deploy-web.yml
    secrets: inherit
    with:
      resource_group: proteinlens-prod
      staticwebapp_name: ${{ needs.infra.outputs.staticwebapp_name }}
      api_url: ${{ needs.infra.outputs.functionapp_url }}

  health_check:
    name: Health Checks
    needs: [infra, deploy_backend, deploy_frontend]
    if: always() && (needs.deploy_backend.result == 'success' || needs.deploy_frontend.result == 'success')
    runs-on: ubuntu-latest
    steps:
      - name: API health check (/api/health -> 200)
        run: |
          URL="${{ needs.infra.outputs.functionapp_url }}/api/health"
          echo "ðŸ” Testing API health: $URL"
          for i in $(seq 1 10); do
            code=$(curl -s -o /dev/null -w "%{http_code}" "$URL" || true)
            echo "Attempt $i: HTTP $code"
            if [ "$code" = "200" ]; then
              echo "âœ… API health check passed"
              exit 0
            fi
            sleep $((2**i > 30 ? 30 : 2**i))
          done
          echo "âŒ API health check failed after 10 attempts"
          exit 1

      - name: Frontend check (index.html -> 200)
        run: |
          URL="${{ needs.infra.outputs.staticwebapp_url }}"
          echo "ðŸ” Testing frontend: $URL"
          for i in $(seq 1 10); do
            code=$(curl -s -o /dev/null -w "%{http_code}" "$URL" || true)
            echo "Attempt $i: HTTP $code"
            if [ "$code" = "200" ]; then
              echo "âœ… Frontend check passed"
              exit 0
            fi
            sleep $((2**i > 30 ? 30 : 2**i))
          done
          echo "âŒ Frontend check failed after 10 attempts"
          exit 1

  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [dns_gate, infra, deploy_backend, deploy_frontend, health_check]
    if: always()
    steps:
      - name: Summarize results
        run: |
          echo "## ðŸ“‹ Deployment Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "| Component | Result |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-----------|--------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| DNS Gate | ${{ needs.dns_gate.outputs.ok || 'false' }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Infra | ${{ needs.infra.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Backend | ${{ needs.deploy_backend.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Frontend | ${{ needs.deploy_frontend.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Health Checks | ${{ needs.health_check.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Endpoints" >> "$GITHUB_STEP_SUMMARY"
          echo "- API: ${{ needs.infra.outputs.functionapp_url }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Web: ${{ needs.infra.outputs.staticwebapp_url }}" >> "$GITHUB_STEP_SUMMARY"
