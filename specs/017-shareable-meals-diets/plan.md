# Implementation Plan: Shareable Meal Scans & Diet Style Profiles

**Branch**: `017-shareable-meals-diets` | **Date**: 2026-01-01 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/017-shareable-meals-diets/spec.md`

## Summary

Transform every meal scan into a shareable, social-media-friendly URL with Open Graph previews. Persist AI-generated Pro Tips in meal history. Add diet style profiles (Keto, Mediterranean, etc.) as a constraint layer with admin-editable configuration.

**Technical approach**: 
- Short URL IDs via nanoid (10-char alphanumeric)
- Server-side rendered HTML for OG tags via Azure Function
- New `DietStyle` entity with admin CRUD
- Extended `MealAnalysis` with `shareId`, `isPublic`, `dietStyleAtScanId`
- `notes` field repurposed as Pro Tip storage (already exists)

## Technical Context

**Language/Version**: TypeScript 5.x, Node.js 20+  
**Primary Dependencies**: React 18, Azure Functions v4, Prisma ORM, shadcn/ui, Tailwind CSS, nanoid  
**Storage**: PostgreSQL (Azure Flexible Server), Azure Blob Storage  
**Testing**: Vitest (unit), Playwright (E2E)  
**Target Platform**: Web (mobile-first responsive)  
**Project Type**: web  
**Performance Goals**: Share URL page load < 200ms (SSR), meal analysis < 5s  
**Constraints**: Constitution compliance (19 principles), existing auth flow, Blob-first storage  
**Scale/Scope**: ~10,000+ shareable meals, 5 default diet styles

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Zero Secrets in Client | ✅ PASS | No new secrets; blob SAS tokens are time-limited |
| II. Least Privilege Access | ✅ PASS | Public meal endpoint has no auth; owner-only for privacy toggle |
| III. Blob-First Ingestion | ✅ PASS | Existing pattern unchanged; images already in blob |
| IV. Traceability | ✅ PASS | `shareId` links to `mealAnalysisId`; `dietStyleAtScanId` snapshots diet |
| V. Deterministic JSON | ✅ PASS | API contracts define schemas; Zod validation |
| VI. Cost Controls | ✅ PASS | Short SAS tokens (1hr); diet style caching (5min) |
| VII. AI Infrastructure | ✅ PASS | Pro Tips from existing AI response; no new AI calls |
| VIII. Privacy & Data Rights | ✅ PASS | `isPublic` toggle; cascade delete preserved |
| IX. Resource Lifecycle | ✅ PASS | No new infrastructure resources |
| X. Secrets Management | ✅ PASS | No new secrets required |
| XI. Key Rotation | N/A | No new keys |
| XII. IaC Idempotency | ✅ PASS | DB migration only; no Bicep changes |
| XIII. Mobile-First | ✅ PASS | Share button in thumb zone; diet selector in Settings |
| XIV. Fast Performance | ✅ PASS | SSR for OG tags; hydration for interactivity |
| XV. Delight | ✅ PASS | Copy-to-clipboard feedback; diet warnings with emoji |
| XVI. Accessibility | ✅ PASS | Keyboard-navigable diet selector; ARIA labels |
| XVII. Design System | ✅ PASS | shadcn/ui components; Tailwind tokens |
| XVIII. Trust UI | ✅ PASS | Pro Tips visible; diet source shown |
| XIX. Action-First | ✅ PASS | Primary: Share button; Secondary: Privacy toggle |

**Gate Result**: ✅ PASS - No violations

## Project Structure

### Documentation (this feature)

```text
specs/017-shareable-meals-diets/
├── plan.md              # This file
├── research.md          # Technical decisions (nanoid, SSR, caching)
├── data-model.md        # Prisma schema changes
├── quickstart.md        # Developer onboarding
├── contracts/           # API specifications
│   ├── public-meal-api.md
│   ├── diet-style-api.md
│   └── meal-api-extension.md
└── tasks.md             # Generated by /speckit.tasks
```

### Source Code (repository root)

```text
backend/
├── prisma/
│   ├── schema.prisma           # +DietStyle, +MealAnalysis fields
│   └── seed.ts                 # +default diet styles
├── src/
│   ├── functions/
│   │   ├── public-meal.ts      # NEW: SSR for /meal/:shareId
│   │   ├── diet-styles.ts      # NEW: GET /api/diet-styles
│   │   ├── user-diet-style.ts  # NEW: PATCH /api/me/diet-style
│   │   ├── meal-privacy.ts     # NEW: PATCH /api/meals/:id/privacy
│   │   ├── admin-diet-styles.ts # NEW: Admin CRUD
│   │   ├── analyze.ts          # MODIFIED: +shareId, +dietFeedback
│   │   └── get-meals.ts        # MODIFIED: +shareUrl, +proTip
│   ├── services/
│   │   ├── dietService.ts      # NEW: Diet style business logic
│   │   └── mealService.ts      # MODIFIED: shareId generation
│   └── utils/
│       └── nanoid.ts           # NEW: shareId generator
└── tests/
    ├── unit/
    │   ├── dietService.test.ts
    │   └── nanoid.test.ts
    └── integration/
        ├── public-meal.test.ts
        └── diet-styles.test.ts

frontend/
├── src/
│   ├── pages/
│   │   ├── SharedMealPage.tsx  # NEW: Public meal view (hydrates SSR)
│   │   ├── Settings.tsx        # MODIFIED: +diet style selector
│   │   └── History.tsx         # MODIFIED: +share button per meal
│   ├── components/
│   │   ├── meal/
│   │   │   ├── ShareButton.tsx # NEW: Copy share URL
│   │   │   └── PrivacyToggle.tsx # NEW: Public/private switch
│   │   └── history/
│   │       └── MealCard.tsx    # MODIFIED: +proTip display
│   ├── hooks/
│   │   ├── useDietStyles.ts    # NEW: Fetch diet styles
│   │   └── useShareMeal.ts     # NEW: Share URL logic
│   └── services/
│       └── dietApi.ts          # NEW: Diet style API client
└── tests/
    └── components/
        └── ShareButton.test.tsx

admin/
├── src/
│   ├── pages/
│   │   └── DietConfigPage.tsx  # NEW: Diet style management
│   └── components/
│       └── DietStyleForm.tsx   # NEW: Edit diet style form
└── tests/
    └── DietConfigPage.test.tsx
```

**Structure Decision**: Web application pattern (frontend + backend + admin). Follows existing repository layout with new files organized by domain (diet, meal sharing).

## Complexity Tracking

> No Constitution violations requiring justification.

| Area | Complexity | Rationale |
|------|------------|-----------|
| SSR for OG tags | Moderate | Required - social crawlers don't execute JS |
| Diet style snapshots | Low | FK on MealAnalysis preserves audit trail |
| nanoid dependency | Low | Well-tested, 108 bytes, URL-safe |

---

## Implementation Phases

### Phase 1: Database & Backend Foundation
- Prisma schema changes (DietStyle, MealAnalysis extensions)
- Migration + seed for default diet styles
- nanoid integration for shareId generation
- Diet style service with caching

### Phase 2: Public Meal Sharing
- SSR Azure Function for /meal/:shareId
- Public meal API endpoint
- Privacy toggle endpoint
- OG meta tag generation

### Phase 3: Diet Style Integration
- User diet style endpoints
- Meal analysis diet feedback
- Admin diet style CRUD

### Phase 4: Frontend Updates
- Shared meal page (hydration)
- Share button component
- Settings diet selector
- History Pro Tip display

### Phase 5: Admin & Polish
- Admin diet configuration page
- E2E tests
- Documentation updates

---

## Dependencies

### New Packages

```json
{
  "nanoid": "^5.0.0"
}
```

### Existing Packages (no changes)
- prisma, @prisma/client
- @azure/functions
- react, react-dom
- zod (validation)

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| shareId collision | Very Low | Medium | Check + retry (3x), DB unique constraint |
| Social preview caching | Medium | Low | Document refresh tools (Twitter validator) |
| Diet feedback performance | Low | Low | 5-minute diet style cache |
| SSR bundle size | Low | Medium | Minimal HTML template; full app in script tag |

---

## Next Steps

1. Run `/speckit.tasks` to generate detailed task breakdown
2. Create feature branch from main
3. Implement Phase 1 (schema + migration)
4. Progress through phases with PR per phase
